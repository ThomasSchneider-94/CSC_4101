<?php

namespace App\DataFixtures;

use App\Entity\Generique;
use App\Entity\Album;
use Doctrine\Bundle\FixturesBundle\Fixture;
use Doctrine\Persistence\ObjectManager;

class AppFixtures extends Fixture
{
    // defines reference names for instances of Rack
    private const ALBUM_THOMAS_1 = 'thomas-album-1';
    private const ALBUM_MAXIME_1 = 'maxime-album-1';

    /**
     * Generates initialization data for album : [description]
     * @return \\Generator
     */
    private static function albumDataGenerator()
    {
        yield ["Album de génériques de Thomas", self::ALBUM_THOMAS_1];
        yield ["Les génériques de Maxime", self::ALBUM_MAXIME_1];
    }

    /**
     * Generates initialization data for generique recommendations:
     *  [film_title, film_year, recommendation]
     * @return \\Generator
     */
    private static function generiqueGenerator()
    {
        yield [self::ALBUM_THOMAS_1, "Oshi no Ko"];
        yield [self::ALBUM_THOMAS_1, "Da Wang Rao Ming"];
        yield [self::ALBUM_MAXIME_1, "Assassination Classroom"];
    }

    public function load(ObjectManager $manager)
    {
        $inventoryRepo = $manager->getRepository(Album::class);

        foreach (self::albumDataGenerator() as [$title, $albumReference] ) {
            $album = new Album();
            $album->setDescription($title);
            $manager->persist($album);
            $manager->flush();

            // Once the Rack instance has been saved to DB
            // it has a valid Id generated by Doctrine, and can thus
            // be saved as a future reference
            $this->addReference($albumReference, $album);
        }

        foreach (self::generiqueGenerator() as [$albumReference, $model])
        {
            // Retrieve the One-side instance of Rack from its reference name
            $album = $this->getReference($albumReference);
            $generique = new Generique();
            $generique->setAnime($model);
            // Add the Many-side Guitar to its containing rack
            $album->addGenerique($generique);

            // Requir that the ORM\OneToMany attribute on Rack::guitars has "cascade: ['persist']"
            $manager->persist($generique);
        }
        $manager->flush();
    }
}
